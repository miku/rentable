{% extends "base.html" %}

{% block scripts %}
    <script src="assets/OpenLayers-2.12/OpenLayers.js"></script>
    <script>
        $(document).ready(function() {
            map = new OpenLayers.Map("map");
            var mapnik         = new OpenLayers.Layer.OSM();
            var fromProjection = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
            var toProjection   = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection
            var position       = new OpenLayers.LonLat(12.38, 51.34).transform(fromProjection, toProjection);
            var zoom           = 12;

            map.addLayer(mapnik);
            map.setCenter(position, zoom);

            // var pois = new OpenLayers.Layer.Text( "My Points",
            //         { location:"{{ urlFor('locations') }}",
            //           projection: map.displayProjection
            //         });
            // map.addLayer(pois);

            var layer = new OpenLayers.Layer.Vector("POIs", {
                strategies: [new OpenLayers.Strategy.BBOX({resFactor: 1.1})],
                protocol: new OpenLayers.Protocol.HTTP({
                    url: "{{ urlFor('locations') }}",
                    format: new OpenLayers.Format.Text()
                })
            });
            map.addLayer(layer);

// Interaction; not needed for initial display.
            selectControl = new OpenLayers.Control.SelectFeature(layer);
            map.addControl(selectControl);
            selectControl.activate();
            layer.events.on({
                'featureselected': onFeatureSelect,
                'featureunselected': onFeatureUnselect
            });

            // Needed only for interaction, not for the display.
            function onPopupClose(evt) {
                // 'this' is the popup.
                var feature = this.feature;
                if (feature.layer) { // The feature is not destroyed
                    selectControl.unselect(feature);
                } else { // After "moveend" or "refresh" events on POIs layer all 
                         //     features have been destroyed by the Strategy.BBOX
                    this.destroy();
                }
            }
            function onFeatureSelect(evt) {
                feature = evt.feature;
                // popup = new OpenLayers.Popup.FramedCloud("featurePopup",
                popup = new OpenLayers.Popup.FramedCloud("featurePopup",
                                     feature.geometry.getBounds().getCenterLonLat(),
                                     new OpenLayers.Size(200,100),
                                     "<h2>"+feature.attributes.title + "</h2>" +
                                     feature.attributes.description,
                                     null, true, onPopupClose);

                feature.popup = popup;
                popup.feature = feature;
                map.addPopup(popup, true);
                console.log($("#featurePopup"));
            }
            function onFeatureUnselect(evt) {
                feature = evt.feature;
                if (feature.popup) {
                    popup.feature = null;
                    map.removePopup(feature.popup);
                    feature.popup.destroy();
                    feature.popup = null;
                }
            }            

        });
    </script>
{% endblock %}

{% block main %}
    <div class="unit span-grid">
        <p>
            Rentable is your premium source for lending just about everyting. There are
            currently {{ random(1000) }} items to lend, from houses to helicopters.
        </p>
    </div>
    <div class="unit span-grid">
        <div id="map"></div>
    </div>
{% endblock %}